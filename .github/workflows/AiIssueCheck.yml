name: AI Issue Checker

on:
  issues:
    types: [opened, edited] 

permissions:
  issues: write
  pull-requests: write

jobs:
  check-issue:
    if: |
      github.event_name == 'issues' &&
      (
        github.event.action == 'opened' ||
        (
          github.event.action == 'edited' &&
          github.event.issue.state == 'open' &&
          contains(github.event.issue.labels.*.name, 'invalid')
        )
      )
    runs-on: ubuntu-latest
    steps:
      - name: Debug API Key existence
        run: |
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "âŒ OPENAI_API_KEY is NOT set"
            exit 1
          else
            echo "âœ… OPENAI_API_KEY is set"
            echo "API Key length: ${#OPENAI_API_KEY}"
          fi
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Run AI Issue Validation
        uses: actions/github-script@v6
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ISSUE_RULES: ${{ vars.ISSUE_RULES }}
          OPENAI_API_URL: ${{ secrets.OPENAI_API_URL }}
        with:
          script: |
            const issue = context.payload.issue
            const issueBody = issue.body || ""
            const rules = process.env.ISSUE_RULES

            const response = await fetch(`${process.env.OPENAI_API_URL}`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`
              },
              body: JSON.stringify({
                model: "gpt-4o-mini",
                messages: [
                  { role: "system", content: rules },
                  { role: "user", content: issueBody }
                ],
                max_tokens: 200
              })
            })

            const data = await response.json()
            let result
            try {
              result = JSON.parse(data.choices[0].message.content)
            } catch (e) {
              result = { valid: true, missing: [] }
            }

            const { data: comments } = await github.rest.issues.listComments({
              issue_number: issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo
            })

            const botComment = comments.find(c => c.user.type === "Bot" && c.body.includes("æ„Ÿè°¢æäº¤ Issue"))

            if (!result.valid) {
              const missingText = result.missing.join("ã€")
              const reasonText = result.reason
              const newBody = `âš ï¸ æ„Ÿè°¢æäº¤ Issueï¼Œä½†ä½ çš„å†…å®¹ç¼ºå°‘ä»¥ä¸‹éƒ¨åˆ†ï¼š**${missingText}**ã€‚\n\n**${reasonText}**\n\nè¯·æ ¹æ®æ¨¡æ¿è¡¥å……å®Œæ•´åå†æäº¤ï¼Œè°¢è°¢ï¼`

              if (botComment) {
                await github.rest.issues.updateComment({
                  comment_id: botComment.id,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: newBody
                })
              } else {
                await github.rest.issues.createComment({
                  issue_number: issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: newBody
                })
              }

              await github.rest.issues.addLabels({
                issue_number: issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ["invalid"]
              })
            } else {
              const passBody = `âœ… æ„Ÿè°¢æäº¤ Issueï¼Œä½ çš„ Issue å·²ç»ç¬¦åˆè¦æ±‚äº†ï¼Œæˆ‘ä»¬ä¼šå°½å¿«å¤„ç†ï½\n\nğŸ’– å¬è¯´ç‚¹äº†Starè®¸æ„¿çš„æˆåŠŸç‡æ›´é«˜å“¦~`

              if (botComment) {
                await github.rest.issues.updateComment({
                  comment_id: botComment.id,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: passBody
                })
              } else {
                await github.rest.issues.createComment({
                  issue_number: issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: passBody
                })
              }

              try {
                await github.rest.issues.removeLabel({
                  issue_number: issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: "invalid"
                })
              } catch (e) {
              }
            }
